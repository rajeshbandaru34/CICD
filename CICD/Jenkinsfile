pipeline {
    agent any

    tools {
        maven 'Maven_3.9.6'
        jdk 'JDK_21'
    }

    stages {
        stage('SampleBuildJobs') {
            steps {
                echo 'Building the project...'
            }
        }

        stage('SampleTestJobs') {
            steps {
                git url: 'https://github.com/rajeshbandaru34/CICD.git', branch: 'main'
                dir('CICD') {
                     bat "mvn clean install -U"
                }
            }
        }

        stage('SampleDeployJobs') {
            steps {
                echo 'Deploying the project...'
            }
        }

        stage('SampleDeliveryJobs') {
            steps {
                echo 'Delivering the project...'
            }
        }
    }

   post {
    always {
        echo 'Pipeline completed.'

        script {
            def testReportDir = new File("${env.WORKSPACE}/CICD/ExtentReports/Suite/Test")
            def latestReport = testReportDir.listFiles()
                .findAll { it.isFile() && it.name ==~ /\d{4}\.\d{2}\.\d{2}\.\d{2}\.\d{2}\.\d{2}\.html/ }
                .sort { a, b -> a.name <=> b.name }
                .last()

            if (latestReport) {
                echo "Latest report file: ${latestReport.absolutePath}"

                // Pass the latest file name to publishHTML
                publishHTML(target: [
                    reportDir: "${testReportDir.absolutePath}",
                    reportFiles: latestReport.name,
                    reportName: 'Dynamic Extent HTML Report',
                    keepAll: true,
                    alwaysLinkToLastBuild: true,
                    allowMissing: false
                ])
            } else {
                echo "No report HTML file found in Test folder."
            }
        }
    }
}

}
